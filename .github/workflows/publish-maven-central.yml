# Workflow to publish TestNG releases to Maven Central via Central Portal

name: Publish to Maven Central

# Manual workflow dispatch for creating releases
on:
  workflow_dispatch:
    inputs:
      publishing_type:
        description: 'Publishing type (AUTOMATIC for auto-release, USER_MANAGED for manual release from portal)'
        required: true
        default: 'USER_MANAGED'
        type: choice
        options:
          - AUTOMATIC
          - USER_MANAGED
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v4

    - name: Gradle wrapper validation
      uses: gradle/actions/wrapper-validation@v3

    # JDK 17 is required for:
    # 1. Building TestNG (jdkBuildVersion=17 in build-parameters)
    # 2. Running the nmcp plugin (requires Java 17+)
    # Note: TestNG artifacts still target Java 11 (targetJavaVersion=11)
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: 17

    - name: Publish to Central Portal
      env:
        CENTRAL_PORTAL_USERNAME: ${{ secrets.NEXUS_USERNAME }}
        CENTRAL_PORTAL_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        SIGNING_PGP_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        SIGNING_PGP_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
      run: |
        ./gradlew publishAggregationToCentralPortal \
          -Prelease=true \
          -PcentralPortal.publishingType=${{ github.event.inputs.publishing_type }} \
          --no-daemon \
          --stacktrace

    - name: Display completion message
      run: |
        if [ "${{ github.event.inputs.publishing_type }}" == "AUTOMATIC" ]; then
          echo "âœ… Artifacts published to Maven Central and will be automatically released."
          echo "Check status at: https://central.sonatype.com/publishing"
        else
          echo "âœ… Artifacts staged in Central Portal."
          echo "ðŸ‘‰ Go to https://central.sonatype.com/publishing to review and publish the deployment."
        fi
